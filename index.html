<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Scormverter</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <script src="https://unpkg.com/fflate@0.8.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
        html,
        body {
            height: 100%;
        }

        .fullwidth {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: white;
        }

        .btn.btn-danger.btn-less-padding {
            padding: 0.1rem;
        }
    </style>
</head>

<body>
    <div id="spinner" class="fullwidth">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div id="error" class="fullwidth d-none">
        <p>An error occured. Please refresh page.</p>
    </div>

    <div class="container h-100">
        <div class="row">
            <h1>SCORMVERTER</h1>
        </div>
        <div class="row h-100">
            <div class="col border">
                <h5>Input files</h5>
                <ul id="inputlist" class="list-group border">
                </ul>
            </div>
            <div class="col border d-flex flex-column">
                <form id="data-form">
                    <div class="input-group mb-3">
                        <span class="input-group-text">Title</span>
                        <input id="course_title" type="text" class="form-control" placeholder="Course Title" required>
                    </div>
                    <div class="input-group mb-3">
                        <label class="input-group-text" for="file_picker">Folder</label>
                        <input id="file_picker" type="file" class="form-control" webkitdirectory directory multiple>
                    </div>
                    <div class="input-group mb-3">
                        <label class="input-group-text" for="logo_picker">Logo</label>
                        <input id="logo_picker" type="file" class="form-control" accept="image/*" required>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Primary Color</span>
                        <input type="color" id="primary_color" name="primary_color" value="#575757" />
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">Background Color</span>
                        <input type="color" id="bg_color" name="bg_color" value="#FFFFFF" />
                    </div>
                    <div class="mb-3">
                        <button id="add_all_output" type="button" class="btn btn-secondary">Move all to Output</button>
                        <button id="add_all_input" type="button" class="btn btn-secondary">Move all to Input</button>
                    </div>
                    <div class="mb-3">
                        <button id="generate" type="submit" class="btn btn-primary">Generate</button>
                    </div>
                </form>

                <div class="mb-3">
                    <span>Progress</span>
                    <div class="progress">
                        <div id="progress" class="progress-bar progress-bar-striped progress-bar-animated"
                            role="progressbar" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <h5>Instructions</h5>
                    <ol>
                        <li>Click "Choose Files" and select a folder.</li>
                        <li>When the mp4 files are loaded, click "Move all to Output" or move individual items from the
                            "Input files" list to "Output files", and vice versa.</li>
                        <li>Enter the title of the file</li>
                        <li>Click "Generate".</li>
                    </ol>
                </div>
                <div class="mb-3">
                    <h5>Note</h5>
                    <p>Everything is processed in the browser. Nothing is stored in the server.</p>
                    <p>These libraries are used:</p>
                    <ul>
                        <li><a href="https://101arrowz.github.io/fflate/">fflate</a></li>
                        <li><a href="https://getbootstrap.com">Bootstrap</a></li>
                        <li><a href="https://github.com/SortableJS/Sortable">Sortable</a></li>
                    </ul>
                </div>
            </div>
            <div class="col border">
                <h5>Output files</h5>
                <ul id="outputlist" class="list-group border">
                </ul>
            </div>
        </div>
    </div>


    <script>
        // load assets
        const assetList = [
            'ims_xml.xsd',
            'imsmanifest.xml',
            'adlcp_rootv1p2.xsd',
            'imscp_rootv1p1p2.xsd',
            'imsmd_rootv1p2p1.xsd',
            'favicon.ico',
            'index.html',
            'assets/index.css',
            'assets/index.js',
            'assets/preview.js',
            'scripts/apiwrapper_custom.js',
            'scripts/scofunctions.js'
        ];
        const excludeAssetList = { 'imsmanifest.xml': true };
        const assetMap = {};
        (async function () {
            try {
                const responses = await Promise.all(assetList.map(path => fetch(`./assets/${path}`)));
                const buffers = await Promise.all(responses.map(r => r.arrayBuffer()));
                buffers.forEach((response, index) => {
                    assetMap[assetList[index]] = new Uint8Array(response);
                });
                document.getElementById('spinner').classList.add('d-none');

            } catch (error) {
                document.getElementById('spinner').classList.add('d-none');
                document.getElementById('error').classList.remove('d-none');
            }
        })();


        // add item to list
        function addItem(ul, name, id) {
            const li = document.createElement('li');
            li.classList.add('list-group-item');
            li.dataset['id'] = id;
            li.innerHTML = `
            <div class="row">
                <span class="col-11">${name}</span>
                <button class="btn btn-danger btn-less-padding col-1">
                    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
                    <!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
                    <svg width="16px" height="16px" viewBox="0 -0.5 21 21" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                            <g id="Dribbble-Light-Preview" transform="translate(-179.000000, -360.000000)" fill="#FFFFFF">
                                <g id="icons" transform="translate(56.000000, 160.000000)">
                                    <path d="M130.35,216 L132.45,216 L132.45,208 L130.35,208 L130.35,216 Z M134.55,216 L136.65,216 L136.65,208 L134.55,208 L134.55,216 Z M128.25,218 L138.75,218 L138.75,206 L128.25,206 L128.25,218 Z M130.35,204 L136.65,204 L136.65,202 L130.35,202 L130.35,204 Z M138.75,204 L138.75,200 L128.25,200 L128.25,204 L123,204 L123,206 L126.15,206 L126.15,220 L140.85,220 L140.85,206 L144,206 L144,204 L138.75,204 Z" id="delete-[#1487]">
                                    </path>
                                </g>
                            </g>
                        </g>
                    </svg>
                </button>
            </div>
            `;
            li.children[0].children[1].addEventListener('click', (e) => {
                li.parentElement.removeChild(li);
            });
            ul.appendChild(li);
        }

        // add file object into zip
        function addFileObj(zip, name, file) {
            return new Promise((res, rej) => {
                const callback = buffer => {
                    const zipFile = new fflate.AsyncZipDeflate(name, { level: 9 });
                    zip.add(zipFile);
                    zipFile.push(buffer, true);
                    res();
                };

                if (file instanceof Uint8Array) {
                    callback(file);
                } else {
                    const reader = new FileReader();
                    reader.onload = () => callback(new Uint8Array(reader.result));
                    reader.onerror = (e) => rej(e);
                    reader.readAsArrayBuffer(file);
                }
            });
        }

        // copy uint8Array
        function copyUint8Array(array) {
            const newArray = new Uint8Array(new ArrayBuffer(array.byteLength));
            newArray.set(array);
            return newArray;
        }
        const generatedIds = {};
        // generate random ID
        // https://www.codemzy.com/blog/random-unique-id-javascript
        function randomId() {
            let id = '';
            do {
                id = Math.random().toString(36).substring(2, 16);
            } while (generatedIds[id] === true);
            generatedIds[id] = true;
            return id;
        }

        function setProgress(progress) {
            document.getElementById('progress').style.width = `${progress * 100}%`;
        }


        const inputList = document.getElementById('inputlist');
        const outputList = document.getElementById('outputlist');
        const inputSortable = Sortable.create(inputList, { group: 'inputoutput' });
        const outputSortable = Sortable.create(outputList, { group: 'inputoutput' });
        let fileList = {};
        document.getElementById('file_picker').addEventListener('change', (e) => {
            const mp4List = Array.from(e.target.files)
                .filter(x => x.name.endsWith('.mp4'))
                .map(x => ({ id: `video-${randomId()}.mp4`, file: x, name: x.name.replace('.mp4', '') }))
                .sort((a, b) => a.name.localeCompare(b.name));
            mp4List.forEach(x => { fileList[x.id] = x; });
            mp4List.forEach(x => addItem(inputList, x.name, x.id));
        });

        document.getElementById('add_all_output').addEventListener('click', (e) => {
            Array.from(inputList.children).forEach((n) => {
                inputList.removeChild(n);
                outputList.appendChild(n);
            });
        });

        document.getElementById('add_all_input').addEventListener('click', (e) => {
            Array.from(outputList.children).forEach((n) => {
                outputList.removeChild(n);
                inputList.appendChild(n);
            });
        });

        document.getElementById('data-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const output = outputSortable.toArray();
            const files = output.map(x => fileList[x]);
            const courseId = randomId();
            const courseTitle = document.getElementById('course_title').value;
            const courseTitleXml =
                courseTitle.replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&apos;");
            const manifestXml = new TextDecoder().decode(assetMap['imsmanifest.xml']).replace(/{{ COURSE_TITLE }}/g, courseTitleXml);
            const manifestJson = {
                "language": "en-US",
                "logo": {
                    "name": "logo.png",
                    "fullPath": `courses/${courseId}/resources/logo.png`,
                    "url": ""
                },
                "name": courseTitle,
                "colorScheme": {
                    "primary": document.getElementById('primary_color').value,
                    "mediaBackground": document.getElementById('bg_color').value
                },
                "modifiedAt": new Date().getDate(),
                "createdAt": new Date().toUTCString(),
                "ownerId": randomId(),
                "available": true,
                "courseId": courseId,
                "baseURL": "./assets",
                "settings": {
                    "showCloseCourseButton": false,
                    "hideProgressBar": false,
                    "navigationMode": "free"
                },
                "folderId": null,
                "pages": files.map((file, index) => ({
                    "order": index + 1,
                    "closedCaption": {
                        "name": "",
                        "fullPath": "",
                        "url": ""
                    },
                    "resourceType": "video",
                    "resourceId": randomId(),
                    "title": file.name,
                    "settings": {
                        "disablePlaybackRate": false,
                        "disableSeek": false,
                        "disablePiP": false
                    },
                    "video": {
                        "vimeoUrl": "",
                        "name": file.id,
                        "url": "",
                        "fullPath": `courses/${courseId}/resources/${file.id}`,
                        "youtubeUrl": "",
                        "type": "upload"
                    }
                }))
            };

            const zipOutput = [];
            const zip = new fflate.Zip((err, dat, final) => {
                if (!err) {
                    zipOutput.push(dat);
                }
                if (final) {
                    const blob = new Blob(zipOutput, { type: 'application/octet-stream' });
                    const downloadLink = document.createElement('a');
                    const objUrl = URL.createObjectURL(blob);
                    downloadLink.href = objUrl;
                    downloadLink.download = `${courseTitle}.zip`;
                    downloadLink.click();
                    setProgress(0);
                    setTimeout(() => URL.revokeObjectURL(objUrl), 50 * 60);
                }
            });

            let totalFiles = assetList.length + files.length + 3;
            // add icon
            addFileObj(zip, 'assets/logo.png', document.getElementById('logo_picker').files[0]);
            // add all script files in first
            await Promise.all(assetList.filter(path => excludeAssetList[path] !== true).map(path => addFileObj(zip, path, copyUint8Array(assetMap[path]))));
            // add manifest XML
            await addFileObj(zip, 'imsmanifest.xml', new TextEncoder().encode(manifestXml));
            // add manifest JSON
            await addFileObj(zip, 'data/course.json', new TextEncoder().encode(JSON.stringify(manifestJson)));
            setProgress((assetList.length + 2) / totalFiles);
            // add videos
            let i = 0;
            while (files.length) {
                const parallelCount = 2;
                const processFiles = files.splice(-parallelCount, parallelCount);
                await Promise.all(processFiles.map(file => addFileObj(zip, `assets/${file.id}`, file.file)));
                i += parallelCount;
                setProgress((assetList.length + 2 + i) / totalFiles);
            }
            zip.end();
        });
    </script>

</body>

</html>